{"version":3,"sources":["webpack://migration-data-model/webpack/universalModuleDefinition","webpack://migration-data-model/webpack/bootstrap","webpack://migration-data-model/external \"sequelize\"","webpack://migration-data-model/./src/constants.js","webpack://migration-data-model/external \"path\"","webpack://migration-data-model/external \"dotenv\"","webpack://migration-data-model/external \"jsonwebtoken\"","webpack://migration-data-model/./src/pubsub.js","webpack://migration-data-model/./src/services/file.js","webpack://migration-data-model/./src/models/sequelize.js","webpack://migration-data-model/./src/models/User.js","webpack://migration-data-model/./src/models/Photo.js","webpack://migration-data-model/./src/models/Album.js","webpack://migration-data-model/./src/models/index.js","webpack://migration-data-model/external \"file-system\"","webpack://migration-data-model/external \"bcrypt\"","webpack://migration-data-model/./src/services/auth.js","webpack://migration-data-model/external \"express\"","webpack://migration-data-model/external \"apollo-server-express\"","webpack://migration-data-model/external \"merge-graphql-schemas\"","webpack://migration-data-model/external \"rimraf\"","webpack://migration-data-model/external \"sharp\"","webpack://migration-data-model/external \"http\"","webpack://migration-data-model/external \"body-parser\"","webpack://migration-data-model/external \"cors\"","webpack://migration-data-model/external \"compression\"","webpack://migration-data-model/external \"graphql-playground-middleware-express\"","webpack://migration-data-model/./src/models/seedUser.js","webpack://migration-data-model/external \"graphql-subscriptions\"","webpack://migration-data-model/external \"progress-stream\"","webpack://migration-data-model/external \"apollo-server\"","webpack://migration-data-model/./src/services/exif.js","webpack://migration-data-model/external \"exif\"","webpack://migration-data-model/external \"image-size\"","webpack://migration-data-model/./src/services/resize.js","webpack://migration-data-model/external \"mkdirp\"","webpack://migration-data-model/./src/services/permissions.js","webpack://migration-data-model/./src/formatErrors.js","webpack://migration-data-model/./src/resolvers/albums.js","webpack://migration-data-model/./src/services/TaskQueue.js","webpack://migration-data-model/./src/services/batch.js","webpack://migration-data-model/./src/resolvers/photos.js","webpack://migration-data-model/./src/services/processFile.js","webpack://migration-data-model/./src/resolvers/users.js","webpack://migration-data-model/./src/resolvers/bin.js","webpack://migration-data-model/./src/resolvers/index.js","webpack://migration-data-model/./src/schema/index.js","webpack://migration-data-model/./src/schema/albums.js","webpack://migration-data-model/./src/schema/photos.js","webpack://migration-data-model/./src/schema/users.js","webpack://migration-data-model/./src/schema/bin.js","webpack://migration-data-model/./src/index.js"],"names":["root","factory","exports","module","require","define","amd","global","__WEBPACK_EXTERNAL_MODULE__0__","__WEBPACK_EXTERNAL_MODULE__2__","__WEBPACK_EXTERNAL_MODULE__3__","__WEBPACK_EXTERNAL_MODULE__4__","__WEBPACK_EXTERNAL_MODULE__8__","__WEBPACK_EXTERNAL_MODULE__9__","__WEBPACK_EXTERNAL_MODULE__11__","__WEBPACK_EXTERNAL_MODULE__12__","__WEBPACK_EXTERNAL_MODULE__13__","__WEBPACK_EXTERNAL_MODULE__14__","__WEBPACK_EXTERNAL_MODULE__15__","__WEBPACK_EXTERNAL_MODULE__17__","__WEBPACK_EXTERNAL_MODULE__18__","__WEBPACK_EXTERNAL_MODULE__19__","__WEBPACK_EXTERNAL_MODULE__20__","__WEBPACK_EXTERNAL_MODULE__23__","__WEBPACK_EXTERNAL_MODULE__24__","__WEBPACK_EXTERNAL_MODULE__25__","__WEBPACK_EXTERNAL_MODULE__27__","__WEBPACK_EXTERNAL_MODULE__28__","__WEBPACK_EXTERNAL_MODULE__30__","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","__webpack_exports__","UPLOAD_FOLDER","PHOTOS_FOLDER","SALT_ROUNDS","ALBUM","PHOTO","SIZES","COVER_SIZE","THUMBNAIL_SIZE","BATCH_CONCURRENCY","DELIM","longestEdge","UPLOAD_STARTED","UPLOAD_PROGRESS","emitUploadProgress","apollo_server__WEBPACK_IMPORTED_MODULE_0__","pubsub","filename","percentage","publish","uploadProgress","__dirname","storeUpload","deletePhotoFiles","cleanUpload","path__WEBPACK_IMPORTED_MODULE_0__","path__WEBPACK_IMPORTED_MODULE_0___default","rimraf__WEBPACK_IMPORTED_MODULE_1__","rimraf__WEBPACK_IMPORTED_MODULE_1___default","file_system__WEBPACK_IMPORTED_MODULE_2__","file_system__WEBPACK_IMPORTED_MODULE_2___default","_constants__WEBPACK_IMPORTED_MODULE_4__","ROOT","a","join","HTTP_URL","process","env","SERVER_URI","PORT","console","log","PHOTO_URL","stream","progress","Promise","resolve","reject","storePath","on","error","truncated","unlinkSync","pipe","err","deleteFile","folder","file","files","async","length","localFiles","filter","map","f","replace","all","external_dotenv_default","config","sequelize","external_sequelize_default","PGDATABASE","PGUSER","PGPASSWORD","host","PGHOST","port","PGPORT","dialect","pool","max","min","acquire","idle","logging","Op","User","id","type","INTEGER","primaryKey","autoIncrement","username","STRING","unique","allowNull","email","password","isAdmin","BOOLEAN","defaultValue","blocked","beforeCreate","u","external_bcrypt_default","hashSync","constants","models_User","models_Photo","urls","JSON","thumbnail","title","caption","width","height","exposure","shutter","aperture","iso","focalLength","dateTaken","DATE","isPublic","bin","indexes","fields","models_Album","slug","description","TEXT","cover","coverId","views","belongsTo","belongsToMany","through","onDelete","findByLogin","login","user","findOne","where","Photo","Album","refreshTokens","tryLogin","jsonwebtoken__WEBPACK_IMPORTED_MODULE_0__","jsonwebtoken__WEBPACK_IMPORTED_MODULE_0___default","bcrypt__WEBPACK_IMPORTED_MODULE_1__","bcrypt__WEBPACK_IMPORTED_MODULE_1___default","createTokens","secret","secret2","rest","sign","expiresIn","token","refreshToken","models","SECRET","SECRET2","userId","decode","raw","refreshSecret","verify","newToken","newRefreshToken","success","errors","path","message","compare","refreshTokenSecret","_index__WEBPACK_IMPORTED_MODULE_0__","USERNAME","EMAIL","PASSWORD","exif__WEBPACK_IMPORTED_MODULE_1__","image_size__WEBPACK_IMPORTED_MODULE_2__","image_size__WEBPACK_IMPORTED_MODULE_2___default","filterExif","data","image","ImageDescription","exif","ExposureTime","ShutterSpeedValue","FNumber","ISO","FocalLength","date","dateParts","split","dateString","Date","convertDate","CreateDate","exifData","resizeImage","file_system__WEBPACK_IMPORTED_MODULE_1__","file_system__WEBPACK_IMPORTED_MODULE_1___default","dotenv__WEBPACK_IMPORTED_MODULE_2__","dotenv__WEBPACK_IMPORTED_MODULE_2___default","mkdirp__WEBPACK_IMPORTED_MODULE_3__","mkdirp__WEBPACK_IMPORTED_MODULE_3___default","sharp__WEBPACK_IMPORTED_MODULE_4__","sharp__WEBPACK_IMPORTED_MODULE_4___default","_constants__WEBPACK_IMPORTED_MODULE_5__","BASE_URL","getNewFileVersion","filePath","version","existsSync","fileExists","dirname","newFilename","basename","ext","extname","body","resize","size","actualWidth","resizeTo","imageIsTooSmall","inPath","outName","fileName","y","getFullYear","toString","getMonth","day","getDate","toLowerCase","safeName","makeFolderName","getDimensions","cb","writePath","outPath","toFormat","toFile","absolutePath","abs","makeRelativePath","e","url","createResolver","resolver","baseResolver","childResolver","parent","args","context","info","permissions","Error","formatErrors","ValidationError","resolvers_albums","Query","allAlbums","[object Object]","and","eq","findAll","include","model","as","order","then","result","dataValues","catch","getPublicAlbums","ne","getAlbum","albumId","Mutation","addAlbum","album","details","updateAlbum","update","addPhotosToAlbum","photoIds","findById","firstPhoto","addPhotos","removePhotosFromAlbum","removePhotos","addView","deleteAlbum","destroy","services_TaskQueue","concurrency","this","running","queue","task","push","next","shift","batch","records","params","sizes","con","limitConcurrency","batchResults","completed","increment","forEach","record","pushTask","argName","empty","photos_Op","PhotosResolver","Subscription","uploadStarted","subscribe","asyncIterator","external_graphql_subscriptions_","payload","allPhotos","orderBy","$albums.id$","attributes","publicPhotos","isNaN","parseInt","uploadPhoto","totalUploadSize","mimetype","services_file","services_exif","processFile","photoData","stringify","uploadPhotos","ctx","reduce","b","updatePhoto","photo","deletePhoto","resolvers_photos","users","auth","addUser","bin_Op","allBinItems","albums","photos","prev","cur","addToBin","ids","returning","in","includes","restore","emptyBin","dotenv__WEBPACK_IMPORTED_MODULE_0__","dotenv__WEBPACK_IMPORTED_MODULE_0___default","path__WEBPACK_IMPORTED_MODULE_1__","path__WEBPACK_IMPORTED_MODULE_1___default","http__WEBPACK_IMPORTED_MODULE_2__","http__WEBPACK_IMPORTED_MODULE_2___default","express__WEBPACK_IMPORTED_MODULE_3__","express__WEBPACK_IMPORTED_MODULE_3___default","body_parser__WEBPACK_IMPORTED_MODULE_4__","body_parser__WEBPACK_IMPORTED_MODULE_4___default","cors__WEBPACK_IMPORTED_MODULE_5__","cors__WEBPACK_IMPORTED_MODULE_5___default","compression__WEBPACK_IMPORTED_MODULE_6__","compression__WEBPACK_IMPORTED_MODULE_6___default","jsonwebtoken__WEBPACK_IMPORTED_MODULE_7__","jsonwebtoken__WEBPACK_IMPORTED_MODULE_7___default","apollo_server_express__WEBPACK_IMPORTED_MODULE_8__","graphql_playground_middleware_express__WEBPACK_IMPORTED_MODULE_9__","graphql_playground_middleware_express__WEBPACK_IMPORTED_MODULE_9___default","merge_graphql_schemas__WEBPACK_IMPORTED_MODULE_10__","_models__WEBPACK_IMPORTED_MODULE_11__","_models_seedUser__WEBPACK_IMPORTED_MODULE_12__","_services_auth__WEBPACK_IMPORTED_MODULE_13__","_package_json__WEBPACK_IMPORTED_MODULE_14__","_constants__WEBPACK_IMPORTED_MODULE_15__","_resolvers__WEBPACK_IMPORTED_MODULE_16__","_schema__WEBPACK_IMPORTED_MODULE_17__","REFRESH_SECRET","wsUri","SERVER_WS","typeDefs","resolvers","schema","server","req","connection","subscriptionsEndpoint","subscriptionsPath","app","use","res","headers","newTokens","set","json","limit","origin","endpoint","static","applyMiddleware","httpServer","createServer","installSubscriptionHandlers","exit","listen","sync"],"mappings":"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","file":"index.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory(require(\"sequelize\"), require(\"path\"), require(\"dotenv\"), require(\"jsonwebtoken\"), require(\"file-system\"), require(\"bcrypt\"), require(\"express\"), require(\"apollo-server-express\"), require(\"merge-graphql-schemas\"), require(\"rimraf\"), require(\"sharp\"), require(\"body-parser\"), require(\"cors\"), require(\"compression\"), require(\"graphql-playground-middleware-express\"), require(\"graphql-subscriptions\"), require(\"progress-stream\"), require(\"apollo-server\"), require(\"exif\"), require(\"image-size\"), require(\"mkdirp\"));\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"migration-data-model\", [\"sequelize\", \"path\", \"dotenv\", \"jsonwebtoken\", \"file-system\", \"bcrypt\", \"express\", \"apollo-server-express\", \"merge-graphql-schemas\", \"rimraf\", \"sharp\", \"body-parser\", \"cors\", \"compression\", \"graphql-playground-middleware-express\", \"graphql-subscriptions\", \"progress-stream\", \"apollo-server\", \"exif\", \"image-size\", \"mkdirp\"], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"migration-data-model\"] = factory(require(\"sequelize\"), require(\"path\"), require(\"dotenv\"), require(\"jsonwebtoken\"), require(\"file-system\"), require(\"bcrypt\"), require(\"express\"), require(\"apollo-server-express\"), require(\"merge-graphql-schemas\"), require(\"rimraf\"), require(\"sharp\"), require(\"body-parser\"), require(\"cors\"), require(\"compression\"), require(\"graphql-playground-middleware-express\"), require(\"graphql-subscriptions\"), require(\"progress-stream\"), require(\"apollo-server\"), require(\"exif\"), require(\"image-size\"), require(\"mkdirp\"));\n\telse\n\t\troot[\"migration-data-model\"] = factory(root[\"sequelize\"], root[\"path\"], root[\"dotenv\"], root[\"jsonwebtoken\"], root[\"file-system\"], root[\"bcrypt\"], root[\"express\"], root[\"apollo-server-express\"], root[\"merge-graphql-schemas\"], root[\"rimraf\"], root[\"sharp\"], root[\"body-parser\"], root[\"cors\"], root[\"compression\"], root[\"graphql-playground-middleware-express\"], root[\"graphql-subscriptions\"], root[\"progress-stream\"], root[\"apollo-server\"], root[\"exif\"], root[\"image-size\"], root[\"mkdirp\"]);\n})(global, function(__WEBPACK_EXTERNAL_MODULE__0__, __WEBPACK_EXTERNAL_MODULE__2__, __WEBPACK_EXTERNAL_MODULE__3__, __WEBPACK_EXTERNAL_MODULE__4__, __WEBPACK_EXTERNAL_MODULE__8__, __WEBPACK_EXTERNAL_MODULE__9__, __WEBPACK_EXTERNAL_MODULE__11__, __WEBPACK_EXTERNAL_MODULE__12__, __WEBPACK_EXTERNAL_MODULE__13__, __WEBPACK_EXTERNAL_MODULE__14__, __WEBPACK_EXTERNAL_MODULE__15__, __WEBPACK_EXTERNAL_MODULE__17__, __WEBPACK_EXTERNAL_MODULE__18__, __WEBPACK_EXTERNAL_MODULE__19__, __WEBPACK_EXTERNAL_MODULE__20__, __WEBPACK_EXTERNAL_MODULE__23__, __WEBPACK_EXTERNAL_MODULE__24__, __WEBPACK_EXTERNAL_MODULE__25__, __WEBPACK_EXTERNAL_MODULE__27__, __WEBPACK_EXTERNAL_MODULE__28__, __WEBPACK_EXTERNAL_MODULE__30__) {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 33);\n","module.exports = __WEBPACK_EXTERNAL_MODULE__0__;","export const UPLOAD_FOLDER = 'uploads';\nexport const PHOTOS_FOLDER = 'photos';\nexport const SALT_ROUNDS = 10;\nexport const ALBUM = 'album';\nexport const PHOTO = 'photo';\n\n// Responsive resizing\n// Number = width\n// Object = { width, height }\nexport const SIZES = [\n  'original',\n  2560,\n  1440,\n  960,\n  700,\n  360,\n  { longestEdge: 150 },\n];\nexport const COVER_SIZE = 5; // item in SIZES array\nexport const THUMBNAIL_SIZE = 6; // item in SIZES array\nexport const BATCH_CONCURRENCY = 5;\nexport const DELIM = '__';\n","module.exports = __WEBPACK_EXTERNAL_MODULE__2__;","module.exports = __WEBPACK_EXTERNAL_MODULE__3__;","module.exports = __WEBPACK_EXTERNAL_MODULE__4__;","import { PubSub } from 'apollo-server';\n\nconst pubsub = new PubSub();\nexport default pubsub;\n\nexport const UPLOAD_STARTED = 'UPLOAD_STARTED';\nexport const UPLOAD_PROGRESS = 'UPLOAD_PROGRESS';\n\nexport const emitUploadStarted = filename =>\n  pubsub.publish(UPLOAD_STARTED, {\n    uploadStarted: filename,\n  });\n\nexport const emitUploadProgress = (filename, percentage) =>\n  pubsub.publish(UPLOAD_PROGRESS, {\n    uploadProgress: { filename, percentage },\n  });\n","import path from 'path';\nimport rimraf from 'rimraf';\nimport fs, { createWriteStream } from 'file-system';\nimport progressStream from 'progress-stream';\nimport { UPLOAD_FOLDER, PHOTOS_FOLDER } from '../constants';\nimport { emitUploadStarted, emitUploadProgress } from '../pubsub';\n\nconst ROOT = path.join(__dirname, '../../');\nconst HTTP_URL = `${process.env.SERVER_URI}:${process.env.PORT}`;\nconsole.log('TCL: HTTP_URL', HTTP_URL);\nconst PHOTO_URL = `${HTTP_URL}/photos`;\n\n// TODO: subscription\n/**\n * This function sets a subscription emitter for upload progress. The progress object exposes\n * properties for transferred (b), remaining (b), length (b) and percentage.\n * @param {*} size in bytes\n * @param {*} filename\n */\nexport const setProgress = (size, filename) =>\n  progressStream(\n    { length: size, time: 10 },\n    progress => console.log(filename, Math.round(progress.percentage))\n    || emitUploadProgress(filename, Math.round(progress.percentage)),\n  );\n\n// TODO: make progress work!\nexport const storeUpload = (stream, filename, progress) =>\n  new Promise((resolve, reject) => {\n    const storePath = path.join(__dirname, `../../${UPLOAD_FOLDER}`, filename);\n    if (progress) {\n      /* stream\n          .pipe(progress)\n          .pipe(createWriteStream(storePath))\n          .on('finish', () => resolve())\n          .on('error', err => reject(err)); */\n    } else {\n      stream\n        .on('error', (error) => {\n          if (stream.truncated) {\n            fs.unlinkSync(storePath);\n          }\n          reject(error);\n        })\n        .pipe(createWriteStream(storePath))\n        .on('finish', () => resolve())\n        .on('error', err => reject(err));\n    }\n  });\n\nconst deleteFile = (folder, filename) => new Promise((resolve) => {\n  const file = path.join(ROOT, folder, filename);\n  rimraf(file, {}, (error) => {\n    if (error) {\n      console.log(`Unable to delete ${filename}`);\n    }\n    resolve();\n  });\n});\n\nexport const deletePhotoFiles = files =>\n  new Promise(async (resolve, reject) => {\n    if (files && files.length) {\n      // Replace any non-null http url with ROOT\n      const deNulledList = files.filter(n => n);\n      const localFiles = deNulledList.map(f => f && f.replace(PHOTO_URL, ''));\n      try {\n        await Promise.all(localFiles.map(f => deleteFile(PHOTOS_FOLDER, f)));\n        resolve();\n      } catch (err) {\n        reject(err);\n      }\n    }\n  });\n\nconst deleteAllFiles = folder => new Promise((resolve) => {\n  rimraf(path.join(ROOT, folder, '/*'), {}, (error) => {\n    if (error) {\n      console.log(`Unable to clean files folder: ${error}`);\n    }\n    resolve();\n  });\n});\n\nexport const cleanUploads = () => deleteAllFiles(UPLOAD_FOLDER);\n\nexport const cleanUpload = filename => deleteFile(UPLOAD_FOLDER, filename);\n","import dotenv from 'dotenv';\nimport Sequelize from 'sequelize';\n\ndotenv.config();\n\nexport default new Sequelize(\n  process.env.PGDATABASE,\n  process.env.PGUSER,\n  process.env.PGPASSWORD,\n  {\n    host: process.env.PGHOST,\n    port: process.env.PGPORT,\n    dialect: 'postgres',\n    pool: {\n      max: 5,\n      min: 0,\n      acquire: 30000,\n      idle: 10000,\n    },\n    logging: false,\n  },\n);\n","import dotenv from 'dotenv';\nimport bcrypt from 'bcrypt';\nimport Sequelize from 'sequelize';\nimport sequelize from './sequelize';\nimport { SALT_ROUNDS } from '../constants';\n\n// export const compareHash = (password, hashed) => bcrypt.compareSync(password, hashed);\n\ndotenv.config();\n\nconst { Op } = Sequelize;\n\nconst User = sequelize.define('users', {\n  id: {\n    type: Sequelize.INTEGER,\n    primaryKey: true,\n    autoIncrement: true,\n  },\n  username: {\n    type: Sequelize.STRING,\n    unique: true,\n    allowNull: false,\n  },\n  email: {\n    type: Sequelize.STRING,\n    unique: true,\n    allowNull: false,\n  },\n  password: {\n    type: Sequelize.STRING,\n    allowNull: false,\n  },\n  isAdmin: {\n    type: Sequelize.BOOLEAN,\n    allowNull: false,\n    defaultValue: false,\n  },\n  blocked: Sequelize.BOOLEAN,\n});\n\n// Hash password before committing to db\nUser.beforeCreate((u) => {\n  u.password = bcrypt.hashSync(u.password, SALT_ROUNDS);\n});\n\nexport const findByLogin = async (login) => {\n  let user = await User.findOne({\n    where: { username: login },\n  });\n\n  if (!user) {\n    user = await User.findOne({\n      where: { email: login },\n    });\n  }\n\n  return user;\n};\n\nexport default User;\n","import Sequelize from 'sequelize';\nimport sequelize from './sequelize';\n\nconst Photo = sequelize.define('photos', {\n  id: {\n    type: Sequelize.INTEGER,\n    primaryKey: true,\n    autoIncrement: true,\n  },\n  name: {\n    type: Sequelize.STRING,\n    allowNull: false,\n  },\n  urls: {\n    type: Sequelize.JSON,\n    allowNull: false,\n  },\n  thumbnail: {\n    type: Sequelize.STRING,\n    allowNull: false,\n  },\n  title: Sequelize.STRING,\n  caption: Sequelize.STRING,\n  width: {\n    type: Sequelize.INTEGER,\n    allowNull: false,\n  },\n  height: {\n    type: Sequelize.INTEGER,\n    allowNull: false,\n  },\n  exposure: Sequelize.INTEGER,\n  shutter: Sequelize.INTEGER,\n  aperture: Sequelize.INTEGER,\n  iso: Sequelize.INTEGER,\n  focalLength: Sequelize.INTEGER,\n  dateTaken: Sequelize.DATE,\n  isPublic: {\n    type: Sequelize.BOOLEAN,\n    allowNull: false,\n    defaultValue: true,\n  },\n  bin: {\n    type: Sequelize.BOOLEAN,\n    allowNull: false,\n    defaultValue: false,\n  },\n},\n{\n  indexes: [\n    {\n      name: 'i_photo_name',\n      unique: true,\n      fields: ['name'],\n    },\n    {\n      name: 'i_photo_title',\n      unique: true,\n      fields: ['title'],\n    },\n  ],\n});\n\nexport default Photo;\n","import Sequelize from 'sequelize';\nimport sequelize from './sequelize';\n\nconst Album = sequelize.define('albums', {\n  id: {\n    type: Sequelize.INTEGER,\n    primaryKey: true,\n    autoIncrement: true,\n  },\n  name: {\n    type: Sequelize.STRING,\n    allowNull: false,\n  },\n  slug: Sequelize.STRING,\n  description: Sequelize.TEXT,\n  cover: Sequelize.STRING,\n  coverId: Sequelize.INTEGER,\n  isPublic: {\n    type: Sequelize.BOOLEAN,\n    allowNull: false,\n    defaultValue: true,\n  },\n  views: {\n    type: Sequelize.INTEGER,\n    allowNull: false,\n    defaultValue: 0,\n  },\n  bin: {\n    type: Sequelize.BOOLEAN,\n    allowNull: false,\n    defaultValue: false,\n  },\n}, {\n  indexes: [\n    {\n      name: 'i_album_name',\n      unique: true,\n      fields: ['name'],\n    },\n  ],\n});\n\n\nexport default Album;\n","import sequelize from './sequelize';\nimport User, { findByLogin } from './User';\nimport Photo from './Photo';\nimport Album from './Album';\n\n// Associations\nPhoto.belongsTo(User);\nAlbum.belongsTo(User);\nPhoto.belongsToMany(Album, { through: 'album_photos' });\nAlbum.belongsToMany(Photo, { through: 'album_photos', onDelete: 'CASCADE' });\n/**\n * Provides the following accessor methods:\n * Album.getPhotos\n * Album.setPhotos\n * Album.addPhoto(s)\n * Album.removePhoto(s)  .. and likelwise for Photos.getAlbums, etc.\n */\n\nexport default {\n  User,\n  findByLogin,\n  Photo,\n  Album,\n  sequelize,\n};\n\n// TODO: add indexes for sort and search cols\n","module.exports = __WEBPACK_EXTERNAL_MODULE__8__;","module.exports = __WEBPACK_EXTERNAL_MODULE__9__;","import jwt from 'jsonwebtoken';\nimport bcrypt from 'bcrypt';\n\nexport const createTokens = async (user, secret, secret2) => {\n  const {\n    id, username, isAdmin, ...rest\n  } = user;\n\n  const createToken = jwt.sign(\n    { user: { id, username, isAdmin } },\n    secret,\n    { expiresIn: '1d' },\n  );\n\n  const createRefreshToken = jwt.sign(\n    { user: { id } },\n    secret2,\n    { expiresIn: '1w' },\n  );\n\n  return [createToken, createRefreshToken];\n};\n\nexport const refreshTokens = async (token, refreshToken, models, SECRET, SECRET2) => {\n  let userId = 0;\n  try {\n    const { user: { id } } = jwt.decode(refreshToken);\n    userId = id;\n  } catch (err) {\n    return {};\n  }\n  if (!userId) { return {}; }\n\n  const user = await models.User.findOne({ where: { id: userId }, raw: true });\n  if (!user) { return {}; }\n\n  const refreshSecret = user.password + SECRET2;\n\n\n  try {\n    jwt.verify(refreshToken, refreshSecret);\n  } catch (err) {\n    console.log('Unable to verify refreshToken');\n    return {};\n  }\n\n  const [newToken, newRefreshToken] = await createTokens(user, SECRET, refreshSecret);\n  return {\n    token: newToken,\n    refreshToken: newRefreshToken,\n    user,\n  };\n};\n\nexport const tryLogin = async (username, password, models, SECRET, SECRET2) => {\n  const user = await models.findByLogin(username);\n  if (!user) {\n    return {\n      success: false,\n      errors: [{ path: 'login', message: 'Wrong login details' }],\n    };\n  }\n\n  const valid = await bcrypt.compare(password, user.password);\n  if (!valid) {\n    // bad password\n    return {\n      success: false,\n      errors: [{ path: 'login', message: 'Wrong login details' }],\n    };\n  }\n  const refreshTokenSecret = user.password + SECRET2;\n  const [token, refreshToken] = await createTokens(user, SECRET, refreshTokenSecret);\n\n  return {\n    success: true,\n    token,\n    refreshToken,\n  };\n};\n","module.exports = __WEBPACK_EXTERNAL_MODULE__11__;","module.exports = __WEBPACK_EXTERNAL_MODULE__12__;","module.exports = __WEBPACK_EXTERNAL_MODULE__13__;","module.exports = __WEBPACK_EXTERNAL_MODULE__14__;","module.exports = __WEBPACK_EXTERNAL_MODULE__15__;","module.exports = require(\"http\");","module.exports = __WEBPACK_EXTERNAL_MODULE__17__;","module.exports = __WEBPACK_EXTERNAL_MODULE__18__;","module.exports = __WEBPACK_EXTERNAL_MODULE__19__;","module.exports = __WEBPACK_EXTERNAL_MODULE__20__;","import models from './index';\n\nconst { User } = models;\n\nexport default async () => {\n  // Create default user\n  const username = process.env.USERNAME || 'test';\n  const email = process.env.EMAIL || 'test@test.com';\n  const password = process.env.PASSWORD || 'password';\n\n  const found = await User.findOne({ where: { email } });\n\n  if (!found) {\n    await User.create({\n      username, email, password, isAdmin: true,\n    });\n  }\n};\n","module.exports = __WEBPACK_EXTERNAL_MODULE__23__;","module.exports = __WEBPACK_EXTERNAL_MODULE__24__;","module.exports = __WEBPACK_EXTERNAL_MODULE__25__;","import path from 'path';\nimport { ExifImage } from 'exif';\nimport sizeOf from 'image-size';\n\n// Convert '2015:07:11 11:56:35' to date\nconst convertDate = (date) => {\n  if (!date) { return null; }\n  const dateParts = date.split(' ');\n  const dateString = [dateParts[0].replace(/:/gm, '-'), dateParts[1]].join('T');\n  return new Date(dateString);\n};\n\n// TODO: read title and caption\nconst filterExif = (data) => {\n  if (!data) { return {}; }\n  return {\n    title: null,\n    caption: data.image && data.image.ImageDescription,\n    exposure: data.exif && data.exif.ExposureTime,\n    shutter: data.exif && data.exif.ShutterSpeedValue,\n    aperture: data.exif && data.exif.FNumber,\n    iso: data.exif && data.exif.ISO,\n    focalLength: data.exif && data.exif.FocalLength,\n    dateTaken: data.exif && convertDate(data.exif.CreateDate),\n  };\n};\n\nexport default filename => new Promise((resolve) => {\n  const file = path.join(__dirname, '../../uploads', filename);\n  // eslint-disable-next-line no-new\n  new ExifImage({ image: file }, ((error, exifData) => {\n    resolve({ ...filterExif(exifData), ...sizeOf(file) });\n  }));\n});\n","module.exports = __WEBPACK_EXTERNAL_MODULE__27__;","module.exports = __WEBPACK_EXTERNAL_MODULE__28__;","import path from 'path';\nimport fs from 'file-system';\nimport dotenv from 'dotenv';\nimport mkdirp from 'mkdirp';\nimport sharp from 'sharp';\nimport {\n  UPLOAD_FOLDER, PHOTOS_FOLDER, SIZES, DELIM, THUMBNAIL_SIZE,\n} from '../constants';\n\ndotenv.config();\n\nconst BASE_URL = path.join(__dirname, `../../${PHOTOS_FOLDER}`);\n\n// Write any missing folders in a file path\nconst writePath = (filePath, cb) => {\n  mkdirp(path.dirname(filePath), (err) => {\n    if (err) return cb(err);\n    return cb();\n  });\n};\n\nconst fileExists = filePath => fs.existsSync(filePath);\n\nconst getNewFileVersion = (filePath, version = 0) => {\n  if (!fileExists(filePath)) {\n    return filePath;\n  }\n  const folder = path.dirname(filePath);\n  const newFilename = path.basename(filePath);\n  const ext = path.extname(newFilename);\n  const body = newFilename.split('.')[0].split(`${DELIM}${version}`)[0];\n  return getNewFileVersion(path.join(folder, `${body}${DELIM}${version + 1}${ext}`), version + 1);\n};\n\nconst safeName = f => f.replace(/[^a-z0-9._-]/gi, '').toLowerCase();\n\nconst makeFolderName = (fileName) => {\n  const d = new Date();\n  const y = d.getFullYear().toString();\n  const m = (d.getMonth() + 1).toString();\n  const day = d.getDate().toString();\n  const filePath = path.join(BASE_URL, y, m, day, safeName(fileName || ''));\n  return getNewFileVersion(filePath);\n};\n\nconst makeRelativePath = (absolutePath) => {\n  const abs = path.join(__dirname, '../..');\n\n  console.log(absolutePath.replace(abs, ''));\n\n  return absolutePath.replace(abs, '');\n};\n\nconst getDimensions = (size) => {\n  if (!size || size === 'original') {\n    return '';\n  }\n  // Set filename with size and an 'h' for fixed-height crops and w for width\n  if (size.height) { return `-${size.height}h`; }\n  if (size.width) { return `-${size.width}w`; }\n  return `-${size}w`;\n};\n\nconst imageIsTooSmall = (actualWidth, resizeTo) => {\n  if (resizeTo === 'original') { return false; }\n  const resizeWidth = resizeTo.width ? resizeTo.width : resizeTo;\n  return (actualWidth < resizeWidth);\n};\n\n// Return a size object oriented to resize the longest edge\nconst longestEdge = ({ width, height }, resizeTo) =>\n  // const aspect = width / height;\n  ((width >= height)\n    ? { width: resizeTo, height: null }\n    : { width: null, height: resizeTo });\n\n// eslint-disable-next-line import/prefer-default-export\nexport const resize = (filename, exif) => size => new Promise((resolve, reject) => {\n  if (imageIsTooSmall(exif.width, size)) {\n    resolve(null); // Don't upsample!\n  } else {\n    if (size.longestEdge) {\n      size = longestEdge(exif, size.longestEdge); // Resize to correct orientation\n    }\n    const inPath = path.join(__dirname, `../../${UPLOAD_FOLDER}`, filename);\n    const ext = path.extname(filename);\n    const outName = makeFolderName(`${filename.split(ext)[0]}${getDimensions(size)}${ext}`);\n    try {\n      writePath(outName, async () => {\n        const outPath = path.join(outName);\n        if (typeof size === 'number') {\n          await sharp(inPath)\n            .resize(size)\n            .toFormat('jpeg')\n            .toFile(outPath);\n        } else {\n          await sharp(inPath)\n            .resize(size.width, size.height)\n            .toFormat('jpeg')\n            .toFile(outPath);\n        }\n        // Convert file paths to relative server paths\n        resolve(makeRelativePath(outPath));\n      });\n    } catch (e) {\n      console.log('resize error:', e.message);\n      reject(e);\n    }\n  }\n});\n\nexport const resizeImage = async (filename, exif) => {\n  try {\n    const name = path.basename(filename);\n    const urls = await Promise.all(SIZES.map(resize(filename, exif)));\n    return {\n      name, urls, thumbnail: urls[THUMBNAIL_SIZE], error: null,\n    };\n  } catch (err) {\n    return { url: null, error: err };\n  }\n};\n\n/* Use like:\n<img srcset=\"elva-fairy-320w.jpg 320w,\n             elva-fairy-480w.jpg 480w,\n             elva-fairy-800w.jpg 800w\"\n     sizes=\"(max-width: 320px) 280px,\n            (max-width: 480px) 440px,\n            800px\"\n     src=\"elva-fairy-800w.jpg\" alt=\"Elva dressed as a fairy\"> */\n","module.exports = __WEBPACK_EXTERNAL_MODULE__30__;","const createResolver = (resolver) => {\n  const baseResolver = resolver;\n  baseResolver.createResolver = (childResolver) => {\n    const newResolver = async (parent, args, context, info) => {\n      await resolver(parent, args, context, info);\n      return childResolver(parent, args, context, info);\n    };\n    return createResolver(newResolver);\n  };\n  return baseResolver;\n};\n\n// requiresAuth\nexport default createResolver((parent, args, { user }) => {\n  if (!user || !user.id) {\n    throw new Error('Not authenticated');\n  }\n});\n\n// export const requiresTeamAccess = createResolver(\n//   async (parent, { channelId }, { user, models },\n//   ) => {\n//     if (!user || !user.id) {\n//       throw new Error('Not authenticated');\n//     }\n//     // check if part of the team\n//     const channel = await models.Channel.findOne({ where: { id: channelId } });\n//     const member = await models.Member.findOne({\n//       where: { teamId: channel.teamId, userId: user.id },\n//     });\n//     if (!member) {\n//       throw new Error(\"You have to be a member of the team to subcribe to it's messages\");\n//     }\n//   },\n// );\n\n// export const directMessageSubscription = createResolver(\n//   async (parent, { teamId, userId }, { user, models },\n//   ) => {\n//     if (!user || !user.id) {\n//       throw new Error('Not authenticated');\n//     }\n\n//     const members = await models.Member.findAll({\n//       where: {\n//         teamId,\n//         [models.sequelize.Op.or]: [{ userId }, { userId: user.id }],\n//       },\n//     });\n\n//     if (members.length !== 2) {\n//       throw new Error('Something went wrong');\n//     }\n//   },\n// );\n","export default (e, models) => {\n  if (e instanceof models.sequelize.ValidationError) {\n    return e.errors.map(error => ({\n      path: error.path,\n      type: error.type,\n      message: error.message,\n    }));\n  }\n  return [{ path: 'name', message: 'something went wrong' }];\n};\n","import Sequelize from 'sequelize';\nimport requiresAuth from '../services/permissions';\nimport formatErrors from '../formatErrors';\nimport { COVER_SIZE } from '../constants';\n\nconst { Op } = Sequelize;\n\nconst AlbumsResolver = {\n  Query: {\n    allAlbums: requiresAuth.createResolver(\n      (parent, { id }, { models, user }) => {\n        const filter = id\n          ? {\n            [Op.and]: {\n              userId: { [Op.eq]: user.id },\n              bin: { [Op.eq]: false },\n              id: { [Op.eq]: id },\n            },\n          }\n          : {\n            [Op.and]: {\n              userId: { [Op.eq]: user.id },\n              bin: { [Op.eq]: false },\n            },\n          };\n        return models.Album.findAll({\n          where: filter,\n          include: [{ model: models.Photo, as: 'photos' }],\n          order: [['name']],\n        })\n          .then(result => ({\n            data: result.map(r => r.dataValues),\n            errors: null,\n          }))\n          .catch(err => ({ data: [], errors: formatErrors(err, models) }));\n      },\n    ),\n\n    // NOTE: Hard-coded user id\n    getPublicAlbums: (parent, args, { models, userId = 1 }) =>\n      models.Album.findAll({\n        where: {\n          [Op.and]: {\n            userId: { [Op.eq]: userId },\n            isPublic: { [Op.eq]: true },\n            bin: { [Op.eq]: false },\n            cover: { [Op.ne]: null },\n          },\n        },\n        include: [{ model: models.Photo, as: 'photos' }],\n        order: [['createdAt', 'DESC']],\n      })\n        .then(result => ({\n          data: result.map(r => r.dataValues),\n          errors: null,\n        }))\n        .catch(err => ({ data: [], errors: formatErrors(err, models) })),\n\n    getAlbum: (parent, { albumId }, { models }) =>\n      models.Album.findOne({\n        where: {\n          [Op.and]: {\n            id: { [Op.eq]: albumId },\n            isPublic: { [Op.eq]: true },\n            bin: { [Op.eq]: false },\n          },\n        },\n        include: [{ model: models.Photo, as: 'photos' }],\n      })\n        .then(result => ({\n          data: result.dataValues,\n          errors: null,\n        }))\n        .catch(err => ({ data: null, errors: formatErrors(err, models) })),\n  },\n\n  Mutation: {\n    addAlbum: requiresAuth.createResolver(\n      async (parent, { album }, { models, user }) => {\n        const { id, ...details } = album;\n        return !!models.Album.create({ ...details, userId: user.id });\n      },\n    ),\n\n    updateAlbum: requiresAuth.createResolver(\n      async (parent, { album }, { models }) => {\n        const { id, ...details } = album;\n        return !!models.Album.update({ ...details }, { where: { id } });\n      },\n    ),\n\n    addPhotosToAlbum: requiresAuth.createResolver(\n      async (parent, { albumId, photoIds }, { models }) => {\n        try {\n          const album = await models.Album.findById(albumId);\n          if (!album) { return false; }\n\n          // Set first photo as default album cover if none set\n          if (!album.dataValues.cover) {\n            const firstPhoto = await models.Photo.findById(photoIds[0]);\n            // Set cover photo id and url\n            const cover = firstPhoto.dataValues.urls[COVER_SIZE];\n            const coverId = firstPhoto.dataValues.id;\n            await models.Album.update({ cover, coverId }, { where: { id: albumId } });\n          }\n\n          // Add photos to the album\n          const result = await album.addPhotos(photoIds);\n          return { data: !!result, errors: null };\n        } catch (err) {\n          return { data: false, errors: formatErrors(err, models) };\n        }\n      },\n    ),\n\n    removePhotosFromAlbum: requiresAuth.createResolver(\n      async (parent, { albumId, photoIds }, { models }) => {\n        try {\n          const album = await models.Album.findById(albumId);\n          if (!album) { return false; }\n          const result = await album.removePhotos(photoIds);\n          return { data: !!result, errors: null };\n        } catch (err) {\n          return { data: false, errors: formatErrors(err, models) };\n        }\n      },\n    ),\n\n    addView: async (parent, { albumId }, { models }) => {\n      const album = await models.Album.findById(albumId);\n      let { views } = album.dataValues;\n      views += 1;\n      return !!album.update({ views });\n    },\n\n    deleteAlbum: requiresAuth.createResolver(\n      async (parent, { albumId }, { models }) =>\n        !!models.Album.destroy({ where: { id: albumId } }),\n    ),\n  },\n};\n\nexport default AlbumsResolver;\n","class TaskQueue {\n  constructor(concurrency = 1) {\n    this.concurrency = concurrency;\n    this.running = 0;\n    this.queue = [];\n  }\n\n  pushTask(task) {\n    this.queue.push(task);\n    this.next();\n  }\n\n  next() {\n    while (this.running < this.concurrency && this.queue.length) {\n      const task = this.queue.shift();\n      // task(() => {\n      task().then(() => {\n        this.running -= 1;\n        this.next();\n      });\n      this.running += 1;\n    }\n  }\n\n  empty() {\n    this.queue = [];\n  }\n}\n\nexport default TaskQueue;\n","import TaskQueue from './TaskQueue';\nimport { BATCH_CONCURRENCY } from '../constants';\n\nconst limitConcurrency = (con) => {\n  if (!con) { return BATCH_CONCURRENCY; }\n  if ((typeof con !== 'number') || con < 1) {\n    return 1;\n  }\n  if (con > BATCH_CONCURRENCY) {\n    return BATCH_CONCURRENCY;\n  }\n  return con;\n};\n\nexport const delay = ms => new Promise(resolve => setTimeout(resolve, ms));\n\nexport default concurrency =>\n  async (records, resolver, params, sizes = []) => {\n    const queue = new TaskQueue(limitConcurrency(concurrency));\n    const batchResults = [];\n    let result;\n\n    await new Promise((resolve, reject) => {\n      if (!records || records.length === 0) { resolve(batchResults); }\n\n      let completed = 0;\n      const increment = () => {\n        completed += 1;\n        if (completed === records.length) { resolve(batchResults); }\n      };\n\n      records.forEach((record, i) => {\n        const task = async () => {\n          try {\n            // Resolver signature is (parent, args, context)\n            const { parent, argName, context } = params;\n            const size = sizes ? sizes[i] : null; // Upload size for photos\n            const args = { [argName]: record, size };\n            result = await resolver(parent, args, context);\n            if (result) { batchResults.push(result); }\n            increment();\n          } catch (err) {\n            increment();\n            queue.empty();\n            // reject here to stop the batch on a general error\n            reject(Error(`Batch upload failed: ${err.message}`));\n          }\n        };\n        queue.pushTask(task);\n      });\n    });\n    return batchResults;\n  };\n","import Sequelize from 'sequelize';\nimport { withFilter } from 'graphql-subscriptions';\nimport {\n  storeUpload, setProgress, cleanUpload, deletePhotoFiles,\n} from '../services/file';\nimport requiresAuth from '../services/permissions';\nimport formatErrors from '../formatErrors';\nimport processFile from '../services/processFile';\nimport batch from '../services/batch';\nimport pubsub, { UPLOAD_STARTED, UPLOAD_PROGRESS } from '../pubsub';\n\nconst { Op } = Sequelize;\n\nconst PhotosResolver = {\n  Subscription: {\n    uploadStarted: {\n      subscribe: () => pubsub.asyncIterator(UPLOAD_STARTED),\n    },\n    uploadProgress: {\n      subscribe: withFilter(\n        () => pubsub.asyncIterator(UPLOAD_PROGRESS),\n        (payload, args) => payload.uploadProgress.filename === args.filename,\n      ),\n      // subscribe: requiresAuth.createResolver(withFilter(\n      //   () => pubsub.asyncIterator(UPLOAD_PROGRESS),\n      //   (payload, args) => payload.uploadProgress.filename === args.filename,\n      // )),\n    },\n  },\n\n  Query: {\n    allPhotos: (parent, { albumId, orderBy }, { models, userId = 1 }) => {\n      const filter = albumId\n        ? {\n          [Op.and]: {\n            userId: { [Op.eq]: userId },\n            bin: { [Op.eq]: false },\n            '$albums.id$': { [Op.eq]: albumId },\n          },\n        }\n        : {\n          [Op.and]: {\n            userId: { [Op.eq]: userId },\n            bin: { [Op.eq]: false },\n          },\n        };\n      const order = orderBy ? orderBy.split('_') : ['id', 'DESC'];\n\n      return models.Photo.findAll({\n        include: [{\n          model: models.Album,\n          attributes: ['id'],\n          through: 'album_photos',\n        }],\n        where: filter,\n        order: [order],\n      })\n        .then(result => ({\n          data: result.map(r => r.dataValues),\n          errors: null,\n        }))\n        .catch(err => ({ data: [], errors: formatErrors(err, models) }));\n    },\n\n    publicPhotos: async (parent, { albumId, orderBy }, { models, userId = 1 }) => {\n      // Determine whether albumId is slug or number\n      let id;\n      if (!isNaN(parseInt(albumId, 10))) {\n        id = parseInt(albumId, 10);\n      } else {\n        // Slug\n        const result = await models.Album.findOne({\n          where: { slug: { [Op.eq]: albumId } },\n        });\n        if (!result) {\n          return {\n            data: [],\n            errors: Error('No album by that name'),\n          };\n        }\n        id = result.dataValues.id;\n      }\n\n      const filter = albumId\n        ? {\n          [Op.and]: {\n            userId: { [Op.eq]: userId },\n            bin: { [Op.eq]: false },\n            isPublic: { [Op.eq]: true },\n            '$albums.id$': { [Op.eq]: id },\n          },\n        }\n        : {\n          [Op.and]: {\n            userId: { [Op.eq]: userId },\n            bin: { [Op.eq]: false },\n          },\n        };\n      const order = orderBy ? orderBy.split('_') : ['id', 'DESC'];\n\n      return models.Photo.findAll({\n        include: [{\n          model: models.Album,\n          attributes: ['id'],\n          through: 'album_photos',\n        }],\n        where: filter,\n        order: [order],\n      })\n        .then(result => ({\n          data: result.map(r => r.dataValues),\n          errors: null,\n        }))\n        .catch(err => ({ data: [], errors: formatErrors(err, models) }));\n    },\n  },\n\n  Mutation: {\n    uploadPhoto: requiresAuth.createResolver(\n      async (parent, { file }, { models, user, totalUploadSize }) => {\n        const { stream, filename, mimetype } = await file;\n\n        // Image files only (jpg)\n        if (mimetype !== 'image/jpeg') {\n          console.error(`User tried to upload a file with mimetype: ${mimetype}`);\n          return { success: false, error: 'You cannot upload this type of file' };\n        }\n\n        try {\n          // const progress = setProgress(size, filename);\n          await storeUpload(stream, filename);\n          // await storeUpload(stream, filename, progress);\n\n          // Process the file\n          const {\n            exif, error, urls, thumbnail, name,\n          } = await processFile(filename);\n\n          // Write to database\n          const photoData = {\n            ...exif, urls, thumbnail, name, userId: user.id,\n          };\n          await models.Photo.create(photoData);\n\n          await cleanUpload(filename);\n\n          return {\n            name, success: true, exif: JSON.stringify(exif), error, thumbnail,\n          };\n        } catch (err) {\n          console.error(`FAIL: Unable to upload ${filename}`);\n          console.error(err.message);\n          return { success: false, error: formatErrors(err, models) };\n        }\n      },\n    ),\n\n    uploadPhotos: requiresAuth.createResolver(\n      async (parent, { files, sizes = [] }, ctx) => {\n        const totalUploadSize = sizes.reduce((a, b) => a + b, 0);\n        const context = { ...ctx, totalUploadSize };\n\n        return batch()(\n          files,\n          PhotosResolver.Mutation.uploadPhoto,\n          { parent, argName: 'file', context },\n          sizes,\n        );\n      },\n    ),\n\n    updatePhoto: requiresAuth.createResolver(\n      async (parent, { photo }, { models }) => {\n        const { id, ...details } = photo;\n        return !!models.Photo.update(details, { where: { id } });\n      },\n    ),\n\n    deletePhoto: requiresAuth.createResolver(\n      async (parent, { id }, { models }) => {\n        const photo = await models.Photo.findOne({ where: { id } });\n        const files = photo.dataValues.urls;\n        await deletePhotoFiles(files);\n        return !!models.Photo.destroy({ where: { id } });\n      },\n    ),\n  },\n};\n\nexport default PhotosResolver;\n","import getExifData from './exif';\nimport { resizeImage } from './resize';\n\nexport default file => new Promise(async (resolve, reject) => {\n  try {\n    const exif = await getExifData(file);\n    const {\n      thumbnail, urls, error, name,\n    } = await resizeImage(file, exif);\n    resolve({\n      exif, error, urls, thumbnail, name,\n    });\n  } catch (e) {\n    reject(e);\n  }\n});\n","import { tryLogin } from '../services/auth';\nimport requiresAuth from '../services/permissions';\nimport formatErrors from '../formatErrors';\n\nexport default {\n  Mutation: {\n    login: (parent, { username, password }, { models, SECRET, SECRET2 }) =>\n      tryLogin(username, password, models, SECRET, SECRET2),\n\n    addUser: requiresAuth.createResolver((parent, args, { models }) =>\n      models.User.create(args)\n        .then(result => ({ id: result.id, errors: null }))\n        .catch(err => ({ id: null, errors: formatErrors(err, models) }))),\n  },\n};\n","import Sequelize from 'sequelize';\nimport requiresAuth from '../services/permissions';\nimport { deletePhotoFiles } from '../services/file';\nimport formatErrors from '../formatErrors';\nimport { ALBUM, PHOTO } from '../constants';\n\nconst { Op } = Sequelize;\n\nconst BinResolver = {\n  Query: {\n    allBinItems: requiresAuth.createResolver(\n      (parent, args, { models, user }) => {\n        const albums = models.Album.findAll({\n          where: {\n            [Op.and]: {\n              userId: { [Op.eq]: user.id },\n              bin: { [Op.eq]: true },\n            },\n          },\n          include: [{ model: models.Photo, as: 'photos' }],\n        })\n          .then(result => ({\n            albums: result.map(r => r.dataValues),\n            errors: null,\n          }))\n          .catch(err => ({ photos: [], errors: formatErrors(err, models) }));\n\n        const photos = models.Photo.findAll({\n          where: {\n            [Op.and]: {\n              userId: { [Op.eq]: user.id },\n              bin: { [Op.eq]: true },\n            },\n          },\n        })\n          .then(result => ({\n            photos: result.map(r => r.dataValues),\n            errors: null,\n          }))\n          .catch(err => ({ albums: [], errors: formatErrors(err, models) }));\n\n        // NOTE: This does not concatenate errors; last one wins!\n        return Promise.all([albums, photos])\n          .then(result => result.reduce((prev, cur) => ({ ...prev, ...cur }), {}))\n          .catch(err => ({ albums: [], photos: [], errors: formatErrors(err, models) }));\n      },\n    ),\n  },\n\n  Mutation: {\n    addToBin: requiresAuth.createResolver(\n      async (parent, { type, ids, albumId }, { models, user }) => {\n        if (type === ALBUM) {\n          try {\n            const result = await models.Album.update({ bin: true }, {\n              returning: true,\n              where: {\n                [Op.and]: {\n                  userId: { [Op.eq]: user.id },\n                  id: { [Op.in]: ids },\n                },\n              },\n            });\n            return !!result;\n          } catch (err) {\n            return false;\n          }\n        }\n        if (type === PHOTO) {\n          try {\n            const result = await models.Photo.update({ bin: true }, {\n              returning: true,\n              where: {\n                [Op.and]: {\n                  userId: { [Op.eq]: user.id },\n                  id: { [Op.in]: ids },\n                },\n              },\n            });\n            // If any cover ids are in the removed set, set them to null\n            const albums = await models.Album.findAll();\n            albums.forEach((album) => {\n              if (ids.includes(album.dataValues.coverId)) {\n                models.Album.update(\n                  { cover: null, coverId: null },\n                  { where: { id: album.dataValues.id } },\n                );\n              }\n            });\n\n            return !!result;\n          } catch (err) {\n            return false;\n          }\n        }\n        return false;\n      },\n    ),\n\n    restore: requiresAuth.createResolver(\n      async (parent, args, { models, user }) => {\n        try {\n          const restoreAlbums = await models.Album.update({ bin: false }, {\n            returning: true,\n            where: {\n              [Op.and]: {\n                userId: { [Op.eq]: user.id },\n                bin: { [Op.eq]: true },\n              },\n            },\n          });\n          const restorePhotos = await models.Photo.update({ bin: false }, {\n            returning: true,\n            where: {\n              [Op.and]: {\n                userId: { [Op.eq]: user.id },\n                bin: { [Op.eq]: true },\n              },\n            },\n          });\n          return true;\n        } catch (err) {\n          return false;\n        }\n      },\n    ),\n\n    emptyBin: requiresAuth.createResolver(\n      async (parent, args, { models, user }) => {\n        try {\n          await models.Album.destroy({\n            returning: true,\n            where: {\n              [Op.and]: {\n                userId: { [Op.eq]: user.id },\n                bin: { [Op.eq]: true },\n              },\n            },\n          });\n          // Need to remove photo files as well as database entries\n          const results = await models.Photo.findAll({\n            attributes: ['id', 'urls'],\n            where: {\n              [Op.and]: {\n                userId: { [Op.eq]: user.id },\n                bin: { [Op.eq]: true },\n              },\n            },\n          });\n          results.forEach(async (result) => {\n            const { id, urls } = result.dataValues;\n            await deletePhotoFiles(urls);\n            await models.Photo.destroy({ where: { id } });\n          });\n          return true;\n        } catch (err) {\n          return false;\n        }\n      },\n    ),\n  },\n};\n\nexport default BinResolver;\n","import albums from './albums';\nimport photos from './photos';\nimport users from './users';\nimport bin from './bin';\n\nexport default [\n  albums,\n  photos,\n  users,\n  bin,\n];\n","import albums from './albums';\nimport photos from './photos';\nimport users from './users';\nimport bin from './bin';\n\nexport default [\n  albums,\n  photos,\n  users,\n  bin,\n];\n","export default `\n  type Album {\n    id: Int!\n    name: String!\n    slug: String\n    description: String\n    cover: String\n    coverId: Int\n    views: Int!\n    isPublic: Boolean!\n    createdAt: String!\n    photos: [Photo!]\n  }\n\n  input AlbumInput {\n    id: Int\n    name: String\n    slug: String\n    description: String\n    cover: String\n    coverId: Int\n    isPublic: Boolean\n  }\n\n  type AlbumResponse {\n    data: Album\n    errors: [Error!]\n  }\n\n  type AlbumsResponse {\n    data: [Album!]\n    errors: [Error!]\n  }\n\n  type AlbumUpdateResponse {\n    data: Boolean!\n    errors: [Error!]\n  }\n\n  type Query {\n    allAlbums(id: Int): AlbumsResponse!\n    getPublicAlbums: AlbumsResponse!\n    getAlbum(albumId: Int!): AlbumResponse!\n  }\n\n  type Mutation {\n    addAlbum(album: AlbumInput!): Boolean!\n    updateAlbum(album: AlbumInput!): Boolean!\n    addPhotosToAlbum(albumId: Int!, photoIds: [Int!]!): AlbumUpdateResponse!\n    removePhotosFromAlbum(albumId: Int!, photoIds: [Int!]!): AlbumUpdateResponse!\n    addView(albumId: Int!): Boolean!\n    deleteAlbum(albumId: Int!): Boolean!\n  }\n`;\n\n// setCover(albumId: Int!, photoId: Int!): AlbumUpdateResponse!\n","export default `\n  scalar Upload\n\n  enum PhotoOrderByInput {\n    id_ASC\n    id_DESC\n    title_ASC\n    title_DESC\n    dateTaken_ASC\n    dateTaken_DESC\n    createdAt_ASC\n    createdAt_DESC\n  }\n\n  type UploadResponse {\n    name: String!\n    success: Boolean!\n    exif: String\n    error: String\n    thumbnail: String\n  }\n\n  type Photo {\n    id: Int!\n    name: String!\n    urls: [String]!\n    thumbnail: String!\n    title: String\n    caption: String\n    width: Int!\n    height: Int!\n    exposure: Int\n    shutter: Int\n    aperture: Int\n    iso: Int\n    focalLength: Int\n    dateTaken: String\n    isPublic: Boolean!\n    createdAt: String!\n  }\n\n  input PhotoInput {\n    id: Int!\n    name: String\n    title: String\n    caption: String\n    isPublic: Boolean\n  }\n\n  type PhotoResponse {\n    data: [Photo!]\n    errors: [Error!]\n  }\n\n  type Progress {\n    filename: String\n    percentage: Int\n  }\n\n  type Query {\n    allPhotos(albumId: Int, orderBy: PhotoOrderByInput): PhotoResponse!\n    publicPhotos(albumId: String, orderBy: PhotoOrderByInput): PhotoResponse!\n  }\n\n  type Mutation {\n    uploadPhoto(file: Upload!): UploadResponse!\n    uploadPhotos(files: [Upload!]!, sizes: [Int!]): [UploadResponse!]!\n    updatePhoto(photo: PhotoInput!): Boolean!\n    deletePhoto(id: Int!): Boolean!\n  }\n\n  type Subscription {\n    uploadStarted: String\n    uploadProgress(filename: String!): Progress\n  }\n`;\n","export default `\n  type Error {\n    path: String\n    message: String\n    type: String\n  }\n\n  type createRecordResponse {\n    id: Int\n    errors: [Error!]\n  }\n\n  type LoginResponse {\n    success: Boolean!\n    token: String\n    refreshToken: String\n    errors: [Error!]\n  }\n\n  type Mutation {\n    addUser(username: String!, email: String!, password: String!, isAdmin: Boolean): createRecordResponse!\n    login(username: String!, password: String!): LoginResponse!\n  }\n`;\n","export default `\n  type BinResponse {\n    albums: [Album!]\n    photos: [Photo!]\n    errors: [Error!]\n  }\n\n  type Query {\n    allBinItems: BinResponse!\n  }\n\n  type Mutation {\n    addToBin(type: String!, ids: [Int!]!, albumId: Int): Boolean!\n    restore: Boolean!\n    emptyBin: Boolean!\n  }\n`;\n","import dotenv from 'dotenv';\nimport path from 'path';\nimport http from 'http';\nimport express from 'express';\nimport bodyParser from 'body-parser';\nimport cors from 'cors';\nimport compression from 'compression';\nimport jwt from 'jsonwebtoken';\nimport { ApolloServer, makeExecutableSchema } from 'apollo-server-express';\nimport playground from 'graphql-playground-middleware-express';\nimport { fileLoader, mergeTypes, mergeResolvers } from 'merge-graphql-schemas';\nimport models from './models';\nimport seedUser from './models/seedUser';\nimport { refreshTokens } from './services/auth';\nimport { version } from '../package.json';\nimport { PHOTOS_FOLDER } from './constants';\nimport resolversSet from './resolvers';\nimport schemaSet from './schema';\n\ndotenv.config();\n\n// eslint-disable-next-line prefer-destructuring\nconst SECRET = process.env.SECRET;\nconst SECRET2 = process.env.REFRESH_SECRET;\nconst wsUri = process.env.SERVER_WS || 'ws://localhost';\nconst port = process.env.PORT || 3001;\n\nconst typeDefs = mergeTypes(schemaSet);\nconst resolvers = mergeResolvers(resolversSet);\nconst schema = makeExecutableSchema({\n  typeDefs,\n  resolvers,\n});\n\nconst server = new ApolloServer({\n  schema,\n  // TODO: Get auth context\n  //  subscriptions: {\n  //   onConnect: (connectionParams, webSocket) => {\n  //     if (connectionParams) {\n  //       // return validateToken(connectionParams.authToken)\n  //       //   .then(findUser(connectionParams.authToken))\n  //       //   .then(user => ({\n  //       //     currentUser: user,\n  //       //   }));\n\n  //       // onConnect: async ({ token, refreshToken }, webSocket) => {\n  //       //   if (token && refreshToken) {\n  //       //     try {\n  //       //       const { user } = jwt.verify(token, SECRET);\n  //       //       return { models, user };\n  //       //     } catch (err) {\n  //       //       const newTokens = await refreshTokens(token, refreshToken, models, SECRET, SECRET2);\n  //       //       return { models, user: newTokens.user };\n  //       //     }\n  //       //   }\n\n  //       //   return { models };\n  //       // },\n\n\n  //       return { user: 1 };\n  //     }\n\n  //     throw new Error('Missing auth token!');\n  //   },\n  // },\n  // Need to use connection context for subscriptions\n  context: ({ req, connection }) => {\n    if (connection) {\n      // connection.context.x-token\n      return {};\n    }\n    return {\n      models,\n      user: req.user,\n      SECRET,\n      SECRET2,\n    };\n  },\n});\n\nconst graphqlEndpoint = '/graphql';\nconst subscriptionsEndpoint = `${wsUri}:${port}${server.subscriptionsPath}`;\nconst app = express();\nconst corsOptions = { origin: '*' };\n\nconst addUser = async (req, res, next) => {\n  const token = req.headers['x-token'];\n  if (token) {\n    try {\n      const { user } = jwt.verify(token, SECRET);\n      req.user = user;\n    } catch (err) {\n      const refreshToken = req.headers['x-refresh-token'];\n      const newTokens = await refreshTokens(token, refreshToken, models, SECRET, SECRET2);\n      if (newTokens.token && newTokens.refreshToken) {\n        res.set('Access-Control-Expose-Headers', 'x-token, x-refresh-token');\n        res.set('x-token', newTokens.token);\n        res.set('x-refresh-token', newTokens.refreshToken);\n      }\n      req.user = newTokens.user;\n    }\n  }\n  next();\n};\n\napp.use(addUser);\napp.use(bodyParser.json({ limit: '4mb' }));\napp.use(cors(corsOptions));\napp.use(compression());\napp.use('/playground', playground({\n  endpoint: graphqlEndpoint,\n  subscriptionsEndpoint,\n}));\napp.use('/photos', express.static(path.join(__dirname, '../', PHOTOS_FOLDER)));\n\nserver.applyMiddleware({ app });\n\n// Set up subscriptions\nconst httpServer = http.createServer(app);\nserver.installSubscriptionHandlers(httpServer);\n\nprocess.on('SIGINT', () => {\n  process.exit(0);\n});\n\n// Start the socket and graphQl servers\nhttpServer.listen({ port }, async () => {\n  await models.sequelize.sync();\n  await seedUser();\n  console.info(`🚀 Portfolio API version ${version} ready`);\n  console.info(`🚀 Subscriptions ready at ${subscriptionsEndpoint}`);\n});\n"],"sourceRoot":""}